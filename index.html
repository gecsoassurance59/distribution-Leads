<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Slack Interne</title>
  <style>
    body {
      margin: 0;
      background: #1e1f22;
      font-family: "Segoe UI", sans-serif;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #loginSection, #chatSection {
      max-width: 900px;
      margin: auto;
      padding: 20px;
      width: 100%;
    }

    input, textarea, button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border: none;
    }

    button {
      background: #5865f2;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    #chatSection {
      display: none;
      flex-direction: column;
      height: 100%;
    }

    #messages {
      background: #2b2d31;
      border-radius: 8px;
      padding: 10px;
      overflow-y: auto;
      height: 60vh;
      margin-bottom: 10px;
    }

    .message {
      background: #3b3d42;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 5px;
    }

    .message .meta {
      font-size: 0.75em;
      color: #aaa;
    }

    #msgInputArea {
      display: flex;
      flex-direction: column;
    }

    #okBtn {
      display: none;
    }
  </style>
</head>
<body>
  <div id="loginSection">
    <h2>Connexion üîê</h2>
    <input type="text" id="ip" placeholder="Votre IP">
    <input type="password" id="mdp" placeholder="Mot de passe">
    <button onclick="login()">Se connecter</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <div id="chatSection">
    <h2>üü¢ Messagerie interne</h2>
    <div id="messages">Chargement...</div>

    <div id="msgInputArea">
      <textarea id="msgInput" rows="3" placeholder="Votre message..."></textarea>
      <button onclick="sendMessage()" id="sendBtn">Envoyer</button>
      <button onclick="okAgent()" id="okBtn">OK</button>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwx3a6QkNHNNW3DvWkumcZ867BBsM7HueMJhZo1kD4xzaphYUh2w0nl8LWo3bFgwLyp/exec";

    let currentUser = {
      ip: "",
      nom: "",
      role: ""
    };

    async function login() {
      const ip = document.getElementById("ip").value.trim();
      const mdp = document.getElementById("mdp").value.trim();
      document.getElementById("loginError").textContent = "";

      if (!ip || !mdp) {
        document.getElementById("loginError").textContent = "Tous les champs sont requis.";
        return;
      }

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "login", ip: ip, motdepasse: mdp })
        });
        const data = await res.json();

        if (data.success) {
          currentUser = { ip: ip, nom: data.nom, role: data.role };
          document.getElementById("loginSection").style.display = "none";
          document.getElementById("chatSection").style.display = "flex";

          if (data.role === "agent") {
            document.getElementById("msgInput").style.display = "none";
            document.getElementById("sendBtn").style.display = "none";
            document.getElementById("okBtn").style.display = "block";
          }

          loadMessages();
          setInterval(loadMessages, 10000); // refresh every 10 seconds
        } else {
          document.getElementById("loginError").textContent = "IP ou mot de passe incorrect.";
        }
      } catch (err) {
        console.error(err);
        document.getElementById("loginError").textContent = "Erreur de connexion au serveur.";
      }
    }

    async function loadMessages() {
      try {
        const res = await fetch(SCRIPT_URL + "?action=getMessages");
        const data = await res.json();

        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "";

        if (Array.isArray(data.messages)) {
          if (data.messages.length === 0) {
            messagesDiv.innerHTML = "<i>Aucun message r√©cent.</i>";
          } else {
            data.messages.forEach(msg => {
              messagesDiv.innerHTML += `
                <div class="message">
                  <strong>${msg.nom || msg.ip} (${msg.role})</strong><br>
                  ${msg.message}
                  <div class="meta">${new Date(msg.timestamp).toLocaleString()}</div>
                </div>
              `;
            });
          }
        }
      } catch (err) {
        console.error("Erreur de chargement des messages", err);
        document.getElementById("messages").innerHTML = "<span style='color:red;'>Erreur de chargement.</span>";
      }
    }

    async function sendMessage() {
      const msg = document.getElementById("msgInput").value.trim();
      if (!msg) return;

      try {
        await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "send",
            ip: currentUser.ip,
            nom: currentUser.nom,
            role: currentUser.role,
            message: msg
          })
        });

        document.getElementById("msgInput").value = "";
        loadMessages();
      } catch (err) {
        alert("Erreur lors de l'envoi du message.");
        console.error(err);
      }
    }

    async function okAgent() {
      try {
        await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "ok",
            ip: currentUser.ip,
            nom: currentUser.nom,
            role: currentUser.role
          })
        });

        document.getElementById("okBtn").disabled = true;
        loadMessages();
      } catch (err) {
        alert("Erreur bouton OK.");
        console.error(err);
      }
    }
  </script>
</body>
</html>
